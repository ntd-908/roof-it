define(["jquery","underscore","magnifier/magnifier"],(function(t,e){"use strict";return function(o,a){var n,i,r,s,h,d="ontouchstart"in document.documentElement,l='[data-gallery-role="gallery"]',f='[data-gallery-role="magnifier"]',u='[data-gallery-role="magnifier-zoom"]',m='[data-gallery-role="fotorama__zoom-in"]',c='[data-gallery-role="fotorama__zoom-out"]',g='[data-gallery-role="stage-shaft"] [data-active="true"] .fotorama__img--full',v="fotorama__img--draggable",w="fotorama__img--zoommable",p="zoom-in-loaded",y="zoom-out-loaded",C="fotorama__zoom-in--disabled",M="fotorama__zoom-out--disabled",E=!1,b=0,k=!1,S=!0;function P(t){return{rw:t.naturalWidth,rh:t.naturalHeight}}function z(t){var e,o,a=t.height(),n=t.width(),i=t.parent().height(),r=t.parent().width();(n>r||a>i)&&(n/a<r/i?(e=i,o=n*(i/a)):(o=r,e=a*r/n),t.css({"min-width":o,"min-height":e}))}function O(t,e){e?t.css({"min-width":t.width(),"min-height":t.height(),width:t.width(),height:t.height()}).addClass(w):(t.css({width:"",height:"",top:"",left:"",right:"",bottom:""}).removeClass(w),z(t))}function T(t){S=!0,k=r=E=!1,t.hasClass(v)&&t.removeClass(v),O(t,!1)}function F(e){e?(t(m).addClass(C),t(c).addClass(M)):(t(m).removeClass(C),t(c).removeClass(M))}function $(t,e,o){var a=t.attr("src");!a||e||o?F(!0):function(t,e){var o=new Image;o.onload=function(){this.height>e.parent().height()||this.width>e.parent().width()?F(!1):F(!0)},o.src=t}(a,t)}function _(e,o){var a,n,i,r,s;e.data.$image&&e.data.$image.length&&(a=P(t(g)[0]),n=e.data.$image.parent().width(),i=e.data.$image.parent().height(),r=n>=a.rw&&i>=a.rh,s=n>e.data.$image.width()&&i>e.data.$image.height(),$(e.data.$image,d,I(e.data.fotorama.activeFrame.$stageFrame)),z(e.data.$image),(e.data.$image.hasClass(w)&&!k||r||s)&&T(e.data.$image),r||x())}function Y(e,o,a,n){var i,s,h,d,f,u,m,c;if(void 0===t(l).data("fotorama"))return!1;t(l).data("fotorama").fullScreen&&(E=!0,s=(i=e.parent()).width(),h=i.height(),f=e.position().top,u=e.position().left,c=e.width()/e.height(),o.height=isNaN(o.height)?o.width/c:o.height,o.width=isNaN(o.width)?o.height*c:o.width,f=o.height>=h?function(t,e,o,a,n){var i;return parseInt(t.css("marginTop"))||parseInt(t.css("marginLeft"))?i=(i=(i=r?e-o/4:0)<n-a?n-a:i)>a-n?a-n:i:(i=(i=(i=e+o/2)<n-a?n-a:i)>0?0:i,!r&&o<0&&(i=i<(n-a)/2?(n-a)/2:i)),i}(e,f,n,o.height,h):0,u=o.width>=s?function(t,e,o,a){var n;return n=(n=(n=t+e/2)<a-o?a-o:n)>0?0:n,!r&&e<0&&(n=n<(a-o)/2?(a-o)/2:n),n}(u,a,o.width,s):0,m=r&&u<(s-o.width)/2?0:u,r?0:f,d=t.extend(o,{top:f,left:u,right:m}),e.css(d))}function x(){var o,a=t("a[href], area[href], input, select, textarea, button, iframe, object, embed, *[tabindex], *[contenteditable]").not("[tabindex=-1], [disabled], :hidden"),n=t(l).data("fotorama"),i=t(":focus");if(void 0===n)return!1;n.fullScreen&&(a.each((function(e){t(this).is(i)&&(o=e)})),n.setOptions({swipe:!k,keyboard:!k}),e.isNumber(o)&&a.eq(o).trigger("focus"))}function X(e,a,n){var i,r,s,l,f,u,c,v,p,y={};return!S||h&&E||!d&&t(m).hasClass(C)||(r=P((i=t(g))[0]),p=(s=i.width())/(l=i.height()),k=!0,x(),i.hasClass(w)||O(i,!0),s>=l?((c=s+(f=a||Math.ceil(s*parseFloat(o.magnifierOpts.fullscreenzoom)/100)))>=r.rw&&(c=r.rw,f=a||c-s,S=!1),v=c/p,u=n||v-l):((v=l+(u=n||Math.ceil(l*parseFloat(o.magnifierOpts.fullscreenzoom)/100)))>=r.rh&&(v=r.rh,u=n||v-l,S=!1),c=v*p,f=a||c-s),s>=l&&s!==r.rw?Y(i,y=t.extend(y,{width:c,height:"auto"}),-f,-u):s<l&&l!==r.rh&&Y(i,y=t.extend(y,{width:"auto",height:v}),-f,-u)),!1}function D(e,a,n){var i,s,l,f,u,m,v,w,p,y,C,b;return!k||h&&E||!d&&t(c).hasClass(M)||(S=!0,i=t(g),u=i.parent().width(),m=i.parent().height(),v=i.width(),w=i.height(),C=v/w,v>=w?(p=a||Math.ceil(v*parseFloat(o.magnifierOpts.fullscreenzoom)/100),l=(s=v-p)/C,y=n||w-l):(y=n||Math.ceil(w*parseFloat(o.magnifierOpts.fullscreenzoom)/100),s=(l=w-y)*C,p=a||v-s),b=function(){C>u/m?(p=v-(s=u),y=w-(l=s/C),f={width:s,height:"auto"}):(y=w-(l=m),p=v-(s=l*C),f={width:"auto",height:l}),Y(i,f,p,y)},v>=w?s>u||l>m?Y(i,f={width:s,height:"auto"},p,y):(k=r=!1,x(),b()):l>m||s>u?Y(i,f={width:"auto",height:l},p,y):(k=r=!1,x(),b())),!1}function N(o){var a,i,f,u,m,c,w,p=!1,y=t(l),C=t(g,y),M=t('[data-gallery-role="stage-shaft"] [data-active="true"]'),z=y.data("fotorama");if(void 0===z)return!1;function O(t){return parseInt(t.get(0).style.top)}function T(o,a,n){var i=+u+a,h=+f+o,d=C.width()/10+20;return r=!0,C.offset().left===M.offset().left+M.width()-C.width()&&39===n.keyCode||s-1<M.offset().left+M.width()-C.width()&&o<0&&e.isNumber(s)&&("mousemove"===n.type||"touchmove"===n.type||"pointermove"===n.type||"MSPointerMove"===n.type)?(s=null,void c(">")):C.offset().left===M.offset().left&&0!==o&&37===n.keyCode||s===M.offset().left&&o>0&&("mousemove"===n.type||"touchmove"===n.type||"pointermove"===n.type||"MSPointerMove"===n.type)?(s=null,void c("<")):(C.height()>M.height()&&(M.height()>C.height()+i?C.css("top",M.height()-C.height()):(a=a<(i=C.height()-O(C)-M.height())?a:i,C.css("top",O(C)+a))),C.width()>M.width()?(h=M.offset().left+M.width()>h+C.width()?M.offset().left+M.width()-C.width():M.offset().left<h?M.offset().left:h,C.offset({left:h}),C.css("right","")):Math.abs(a)<1&&k&&"mousemove"!==n.type&&"touchmove"!==n.type&&"pointermove"!==n.type&&"MSPointerMove"!==n.type&&(o<0?t(l).data("fotorama").show(">"):t(l).data("fotorama").show("<")),void(C.width()<=M.width()&&k&&("mousemove"===n.type||"touchmove"===n.type||"pointermove"===n.type||"MSPointerMove"===n.type)&&Math.abs(o)>Math.abs(a)&&Math.abs(o)>d&&c(o<0?">":"<")))}function F(t){var e,o=P(C[0]);o.rh<C.parent().height()&&o.rw<C.parent().width()||(e=o.rw/o.rh,S?X(0,o.rw-C.width(),o.rh-C.height()):e>M.width()/M.height()?D(0,o.rw-M.width(),o.rw/e):D(0,o.rw*e,o.rh-M.height()))}function Y(t){return Math.sqrt((t.touches[0].clientX-t.touches[1].clientX)*(t.touches[0].clientX-t.touches[1].clientX)+(t.touches[0].clientY-t.touches[1].clientY)*(t.touches[0].clientY-t.touches[1].clientY))}c=e.throttle((function(e){t(l).data("fotorama").show(e)}),500,{trailing:!1}),d?(C.off("tap"),C.on("tap",(function(t){var e;0===t.originalEvent.originalEvent.touches.length&&((e=(new Date).getTime()-b)<400&&e>0?(E=!1,b=0,F()):b=(new Date).getTime())}))):(C.off("dblclick"),C.on("dblclick",F)),z.fullScreen&&$(C,d,I(o.activeFrame.$stageFrame)),C.off(d?"touchstart":"pointerdown mousedown MSPointerDown"),C.on(d?"touchstart":"pointerdown mousedown MSPointerDown",(function(t){t&&t.originalEvent.touches&&t.originalEvent.touches.length>=2?(t.preventDefault(),w=Y(t.originalEvent),p=!1,C.hasClass(v)&&C.removeClass(v)):!z.fullScreen||h&&E||(u=O(C),f=C.offset().left,d&&(m=t.originalEvent.touches[0]||t.originalEvent.changedTouches[0],t.clientX=m.pageX,t.clientY=m.pageY),a=t.clientX||t.originalEvent.clientX,i=t.clientY||t.originalEvent.clientY,p=!0),C.offset()&&C.width()>M.width()&&(s=C.offset().left)})),C.off(d?"touchmove":"mousemove pointermove MSPointerMove"),C.on(d?"touchmove":"mousemove pointermove MSPointerMove",(function(e){if(e&&e.originalEvent.touches&&e.originalEvent.touches.length>=2){e.preventDefault();var o=Y(e.originalEvent);C.hasClass(v)&&C.removeClass(v),o<w?(D(),w=o):o>w&&(X(),w=o)}else{var n,r;!z.fullScreen||!p||h&&E||(k&&!C.hasClass(v)&&C.addClass(v),n=e.clientX||e.originalEvent.clientX,r=e.clientY||e.originalEvent.clientY,d&&(n=(m=e.originalEvent.touches[0]||e.originalEvent.changedTouches[0]).pageX,r=m.pageY),k&&(u=O(t(g,y)),T(n-a,r-i,e)))}})),C.off("transitionend webkitTransitionEnd mozTransitionEnd msTransitionEnd "),C.on("transitionend webkitTransitionEnd mozTransitionEnd msTransitionEnd",(function(){E=!1})),n&&t(document).off("keydown",n),n=function(e){var o=t(":focus"),a=t(l).data("fotorama").fullScreen,n=function(){f=t(g,y).offset().left,u=O(t(g,y))};!o.attr("data-gallery-role")&&o.length||!k||(a&&(f=t(g,t(l)).offset().left,u=O(t(g,t(l)))),39===e.keyCode&&a&&(n(),T(-40,0,e)),38===e.keyCode&&a&&(n(),T(0,40,e)),37===e.keyCode&&a&&(n(),T(40,0,e)),40===e.keyCode&&a&&(e.preventDefault(),n(),T(0,-40,e))),27===e.keyCode&&a&&k&&t(l).data("fotorama").cancelFullScreen()},t(document).on("keydown",n),t(document).on(d?"touchend":"mouseup pointerup MSPointerUp",(function(t){z.fullScreen&&(C.offset()&&C.width()>M.width()&&(s=C.offset().left),p=!1,C.removeClass(v))})),t(window).off("resize",_),t(window).on("resize",{$image:C,fotorama:o},_)}function I(t){return t.hasClass("fotorama-video-container")}return(d=d&&(navigator.maxTouchPoints||navigator.msMaxTouchPoints)&&navigator.userAgent.match(/Android|webOS|iPhone|iPad|iPod|BlackBerry|Windows Phone/i))&&t(a).on("fotorama:showend fotorama:load",(function(){t(f).remove(),t(u).remove()})),h=void 0!==document.documentElement.style.transition||void 0!==document.documentElement.style.WebkitTransition||void 0!==document.documentElement.style.MozTransition||void 0!==document.documentElement.style.MsTransition||void 0!==document.documentElement.style.OTransition,i=function(){t(f).empty().hide(),t(u).remove()},o.magnifierOpts.enabled&&t(a).on("pointerdown mousedown MSPointerDown",(function(e){var o=[e.pageX,e.pageY];t(a).on("mousemove pointermove MSPointerMove",(function(e){navigator.msPointerEnabled?i():function(e,o){var a=[e.pageX,e.pageY],n="arrow"===t(e.target).data("gallery-role"),r=o[0]===a[0]&&o[1]===a[1],s=t(e.target).parent().data("active");(n||s&&!r)&&i()}(e,o)})),t(document).on("mouseup pointerup MSPointerUp",(function(){t(a).off("mousemove pointermove MSPointerMove")}))})),t.extend(o.magnifierOpts,{zoomable:!1,thumb:".fotorama__img",largeWrapper:'[data-gallery-role="magnifier"]',height:o.magnifierOpts.height||function(){return t('[data-active="true"]').height()},width:o.magnifierOpts.width||function(){var e=t(l).parent().parent();return e.parent().width()-e.width()-20},left:o.magnifierOpts.left||function(){return t(l).offset().left+t(l).width()+20},top:o.magnifierOpts.top||function(){return t(l).offset().top}}),t(a).on("fotorama:load fotorama:showend fotorama:fullscreenexit fotorama:ready",(function(e,a){if(void 0===t(l).data("fotorama"))return!1;var n=t(l).data("fotorama").activeFrame.$stageFrame;n.find(u).length||(i(),o.magnifierOpts&&(o.magnifierOpts.large=t(l).data("fotorama").activeFrame.img,o.magnifierOpts.full=a.data[a.activeIndex].original,!I(n)&&t(n).magnify(o.magnifierOpts)))})),t(a).on("gallery:loaded",(function(o){var n;t(a).find(l).on("fotorama:ready",(function(e,o){var a=t(m),n=t(c);a.hasClass(p)||(a.on("click touchstart",X),a.on("mousedown",(function(t){t.stopPropagation()})),a.on("keyup",(function(t){13===t.keyCode&&X()})),t(window).on("keyup",(function(t){(107===t.keyCode||o.fullscreen)&&X()})),a.addClass(p)),n.hasClass(y)||(n.on("click touchstart",D),n.on("mousedown",(function(t){t.stopPropagation()})),n.on("keyup",(function(t){13===t.keyCode&&D()})),t(window).on("keyup",(function(t){(109===t.keyCode||o.fullscreen)&&D()})),n.addClass(y))})).on("fotorama:fullscreenenter fotorama:showend",(function(e,o){i(),t(g).is(n)||T(t(g)),N(o),function(e,o,a){var n=o.activeFrame.$stageFrame,i=n.get(0);function r(e){var o=e.deltaY||e.wheelDelta;e||window.event,t(l).data("fotorama").fullScreen&&(e.deltaY?o>0?D():X():o>0?X():D())}n.hasClass("magnify-wheel-loaded")||i&&i.addEventListener&&("onwheel"in document?i.addEventListener("wheel",r,{passive:!0}):"onmousewheel"in document?i.addEventListener("mousewheel",r):i.addEventListener("MozMousePixelScroll",r),n.addClass("magnify-wheel-loaded"))}(0,o),n&&(z(n),t(g).is(n)||T(n)),x()})).on("fotorama:load",(function(e,o){if(void 0===t(l).data("fotorama"))return!1;t(l).data("fotorama").fullScreen&&$(t(g),d,I(o.activeFrame.$stageFrame)),N(o)})).on("fotorama:show",(function(o,a){n=e.clone(t(g)),i()})).on("fotorama:fullscreenexit",(function(e,o){T(t(g)),i(),F(!0)}))})),o}}));
